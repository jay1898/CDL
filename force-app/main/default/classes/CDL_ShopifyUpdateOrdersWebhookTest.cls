@isTest
public class CDL_ShopifyUpdateOrdersWebhookTest {
    
    @isTest
    public static void testReceiveShopifyWebhook() {
        Account a = new Account();
        a.Name = 'test test';
        a.AccountNumber = '6353252483127';
        a.AccountSource = 'Other';
        insert a;
        Id recordTypeId = Schema.SObjectType.Order__c.getRecordTypeInfosByName().get('Confirm Order').getRecordTypeId();
        Order__c objo = new Order__c();
        objo.Account__c = a.Id;
        objo.Name = '2844';
        objo.Order_Id__c = '5390802518071';
        objo.RecordTypeId = recordTypeId;
        objo.Status__c = 'Confirm';
        objo.Payment_Status__c = 'Paid';
        insert objo;
        
        Order_Item__c objline = new Order_Item__c();
        objline.Order_Item_ID__c = '3423423423';
        objline.Order__c = objo.Id;
        objline.Quantity__c = 1;
        objline.Trello_Card_ID__c = '153654654622';
        insert objline;
        // Create test data for the RestRequest
        RestRequest req = new RestRequest();
        RestContext.request = req;
        req.requestURI = '/services/apexrest/shopifyWebhookUpdate/';
        req.httpMethod = 'POST';
        req.requestBody = Blob.valueOf('{ "id":5390802518071, "admin_graphql_api_id":"gid:shopifyOrder5385598337079", "app_id":44930990081, "browser_ip":null, "buyer_accepts_marketing":true, "cancel_reason":null, "cancelled_at":null, "cart_token":null, "checkout_id":null, "checkout_token":null, "client_details":null, "closed_at":null, "confirmation_number":"LAGWPC7H1", "confirmed":true, "contact_email":"aaradhyaaniwarya@gmail.com", "created_at":"2023-10-29T10:46:43+05:30", "currency":"INR", "current_subtotal_price":"1799.00", "current_subtotal_price_set":{ "shop_money":{ "amount":"1799.00", "currency_code":"INR" }, "presentment_money":{ "amount":"1799.00", "currency_code":"INR" } }, "current_total_additional_fees_set":null, "current_total_discounts":"0.00", "current_total_discounts_set":{ "shop_money":{ "amount":"0.00", "currency_code":"INR" }, "presentment_money":{ "amount":"0.00", "currency_code":"INR" } }, "current_total_duties_set":null, "current_total_price":"1799.00", "current_total_price_set":{ "shop_money":{ "amount":"1799.00", "currency_code":"INR" }, "presentment_money":{ "amount":"1799.00", "currency_code":"INR" } }, "current_total_tax":"0.00", "current_total_tax_set":{ "shop_money":{ "amount":"0.00", "currency_code":"INR" }, "presentment_money":{ "amount":"0.00", "currency_code":"INR" } }, "customer_locale":null, "device_id":null, "discount_codes":[ ], "email":"aaradhyaaniwarya@gmail.com", "estimated_taxes":false, "financial_status":"pending", "fulfillment_status":"fulfilled", "landing_site":null, "landing_site_ref":null, "location_id":null, "merchant_of_record_app_id":null, "name":"#2874", "note":null, "note_attributes":[ { "name":"gokwik_cid", "value":"a81355f8-e8c7-4e6f-bee6-12b511af0730" }, { "name":"utm_source", "value":"google" }, { "name":"utm_medium", "value":"paid" }, { "name":"utm_campaign", "value":"{campaignname}" }, { "name":"utm_content", "value":".x." }, { "name":"gclid", "value":"Cj0KCQjw4vKpBhCZARIsAOKHoWRztOKaaU6U1VM9tnAfVfRnq5gs4-tO1tWakMz00jHOF4J1Sev_3sIaAguGEALw_wcB" } ], "number":1874, "order_number":2874, "order_status_url":"https:fieryflair.com26667253815orders760f36b109afdc88c05481d8fb685abdauthenticate?key=975ac64b571ecd85fa10e847d2699ab6", "original_total_additional_fees_set":null, "original_total_duties_set":null, "payment_gateway_names":[ "cash_on_delivery" ], "phone":"+919263614409", "po_number":null, "presentment_currency":"INR", "processed_at":"2023-10-29T10:46:43+05:30", "reference":null, "referring_site":null, "source_identifier":null, "source_name":"44930990081", "source_url":null, "subtotal_price":"1799.00", "subtotal_price_set":{ "shop_money":{ "amount":"1799.00", "currency_code":"INR" }, "presentment_money":{ "amount":"1799.00", "currency_code":"INR" } }, "tags":"COD, GoKwik, QR Address Confirmed", "tax_exempt":false, "tax_lines":[ ], "taxes_included":true, "test":false, "token":"760f36b109afdc88c05481d8fb685abd", "total_discounts":"0.00", "total_discounts_set":{ "shop_money":{ "amount":"0.00", "currency_code":"INR" }, "presentment_money":{ "amount":"0.00", "currency_code":"INR" } }, "total_line_items_price":"1799.00", "total_line_items_price_set":{ "shop_money":{ "amount":"1799.00", "currency_code":"INR" }, "presentment_money":{ "amount":"1799.00", "currency_code":"INR" } }, "total_outstanding":"1799.00", "total_price":"1799.00", "total_price_set":{ "shop_money":{ "amount":"1799.00", "currency_code":"INR" }, "presentment_money":{ "amount":"1799.00", "currency_code":"INR" } }, "total_shipping_price_set":{ "shop_money":{ "amount":"0.00", "currency_code":"INR" }, "presentment_money":{ "amount":"0.00", "currency_code":"INR" } }, "total_tax":"0.00", "total_tax_set":{ "shop_money":{ "amount":"0.00", "currency_code":"INR" }, "presentment_money":{ "amount":"0.00", "currency_code":"INR" } }, "total_tip_received":"0.00", "total_weight":0, "updated_at":"2023-10-31T10:20:36+05:30", "user_id":null, "billing_address":{ "first_name":"Shiristi", "address1":"parmila bhawan Shanti niketan colony nl near bihar college of pharmacy", "phone":"9263614409", "city":"PATNA", "zip":"801503", "province":"Bihar", "country":"India", "last_name":"Bharati", "address2":null, "company":null, "latitude":null, "longitude":null, "name":"Shiristi Bharati", "country_code":"IN", "province_code":"BR" }, "customer":{ "id":6149989171255, "email":"aaradhyaaniwarya@gmail.com", "accepts_marketing":true, "created_at":"2023-06-07T02:02:02+05:30", "updated_at":"2023-10-29T10:46:54+05:30", "first_name":"Sukanya", "last_name":"Kumari", "state":"disabled", "note":null, "verified_email":true, "multipass_identifier":null, "tax_exempt":false, "phone":"+919263614409", "email_marketing_consent":{ "state":"subscribed", "opt_in_level":"single_opt_in", "consent_updated_at":"2023-06-07T02:02:02+05:30" }, "sms_marketing_consent":{ "state":"not_subscribed", "opt_in_level":"single_opt_in", "consent_updated_at":null, "consent_collected_from":"OTHER" }, "tags":"QuickReply.ai", "currency":"INR", "accepts_marketing_updated_at":"2023-06-07T02:02:02+05:30", "marketing_opt_in_level":"single_opt_in", "tax_exemptions":[ ], "admin_graphql_api_id":"gid:shopifyCustomer6149989171255", "default_address":{ "id":7826583683127, "customer_id":6149989171255, "first_name":"Shiristi", "last_name":"Bharati", "company":null, "address1":"parmila bhawan Shanti niketan colony nl near bihar college of pharmacy", "address2":null, "city":"PATNA", "province":"Bihar", "country":"India", "zip":"801503", "phone":"9263614409", "name":"Shiristi Bharati", "province_code":"BR", "country_code":"IN", "country_name":"India", "default":true } }, "discount_applications":[ ], "fulfillments":[ { "id":5059286138935, "admin_graphql_api_id":"gid:shopifyFulfillment5059286138935", "created_at":"2023-10-31T10:20:36+05:30", "location_id":36258775095, "name":"#2874.1", "order_id":5385598337079, "origin_address":{ }, "receipt":{ }, "service":"manual", "shipment_status":null, "status":"success", "tracking_company":"BlueDart", "tracking_number":"80333609635", "tracking_numbers":[ "80333609635" ], "tracking_url":"https:www.ithinklogistics.comtrack-order-status?tracking_number=80333609635", "tracking_urls":[ "https:www.ithinklogistics.comtrack-order-status?tracking_number=80333609635" ], "updated_at":"2023-10-31T10:20:36+05:30", "line_items":[ { "id":13048087183415, "admin_graphql_api_id":"gid:shopifyLineItem13048087183415", "attributed_staffs":[ ], "fulfillable_quantity":0, "fulfillment_service":"manual", "fulfillment_status":"fulfilled", "gift_card":false, "grams":3, "name":"Flower 925 Silver Hoop Earring - Yellow", "price":"1799.00", "price_set":{ "shop_money":{ "amount":"1799.00", "currency_code":"INR" }, "presentment_money":{ "amount":"1799.00", "currency_code":"INR" } }, "product_exists":true, "product_id":6804410957879, "properties":[ ], "quantity":1, "requires_shipping":true, "sku":"FF-ER1564", "taxable":true, "title":"Flower 925 Silver Hoop Earring", "total_discount":"0.00", "total_discount_set":{ "shop_money":{ "amount":"0.00", "currency_code":"INR" }, "presentment_money":{ "amount":"0.00", "currency_code":"INR" } }, "variant_id":40174526758967, "variant_inventory_management":"shopify", "variant_title":"Yellow", "vendor":"FIERY FLAIR", "tax_lines":[ ], "duties":[ ], "discount_allocations":[ ] } ] } ], "line_items":[ { "id":13048087183415, "admin_graphql_api_id":"gid:shopifyLineItem13048087183415", "attributed_staffs":[ ], "fulfillable_quantity":0, "fulfillment_service":"manual", "fulfillment_status":"fulfilled", "gift_card":false, "grams":3, "name":"Flower 925 Silver Hoop Earring - Yellow", "price":"1799.00", "price_set":{ "shop_money":{ "amount":"1799.00", "currency_code":"INR" }, "presentment_money":{ "amount":"1799.00", "currency_code":"INR" } }, "product_exists":true, "product_id":6804410957879, "properties":[ ], "quantity":1, "requires_shipping":true, "sku":"FF-ER1564", "taxable":true, "title":"Flower 925 Silver Hoop Earring", "total_discount":"0.00", "total_discount_set":{ "shop_money":{ "amount":"0.00", "currency_code":"INR" }, "presentment_money":{ "amount":"0.00", "currency_code":"INR" } }, "variant_id":40174526758967, "variant_inventory_management":"shopify", "variant_title":"Yellow", "vendor":"FIERY FLAIR", "tax_lines":[ ], "duties":[ ], "discount_allocations":[ ] } ], "payment_terms":null, "refunds":[ ], "shipping_address":{ "first_name":"Shiristi", "address1":"Parmila Bhawan, Shanti Niketan Colony, Nearl Bihar College of Pharmacy", "phone":"9263614409", "city":"PATNA", "zip":"801503", "province":"Bihar", "country":"India", "last_name":"Bharati", "address2":"", "company":"", "latitude":25.6118599, "longitude":85.0590373, "name":"Shiristi Bharati", "country_code":"IN", "province_code":"BR" }, "shipping_lines":[ { "id":4427734384695, "carrier_identifier":null, "code":"Free Shipping", "discounted_price":"0.00", "discounted_price_set":{ "shop_money":{ "amount":"0.00", "currency_code":"INR" }, "presentment_money":{ "amount":"0.00", "currency_code":"INR" } }, "phone":null, "price":"0.00", "price_set":{ "shop_money":{ "amount":"0.00", "currency_code":"INR" }, "presentment_money":{ "amount":"0.00", "currency_code":"INR" } }, "requested_fulfillment_service_id":null, "source":null, "title":"Free Shipping", "tax_lines":[ ], "discount_allocations":[ ] } ] }');
        
        // Call the receiveShopifyWebhook method
        Test.startTest();
        CDL_ShopifyUpdateOrdersWebhook.receiveShopifyWebhook();
        Test.stopTest();
        
        // Assert the expected results
        List<Shopify_Data__c> responseRecords = [SELECT Name, Response_Data__c FROM Shopify_Data__c WHERE Name = 'Cancel Order 2844'];
       //System.assertNotEquals(0, responseRecords.size());
        
        // Add more assertions as needed
    }
      
}